<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mountain">
    <select id="selectMountainByRank" resultType="map" parameterType="int">
        <![CDATA[
            SELECT thisWeek.MTNM, NVL(prevWeek.rank - thisWeek.rank,'-999') changeRank
            FROM (
            SELECT g.MTNM,DENSE_RANK() OVER (ORDER BY COUNT(g.MTNM) DESC) rank
            FROM groups g
            WHERE g.MTNM != '0'
              AND g.CREATEDAT BETWEEN TO_DATE(sysdate-7)
              AND   TO_DATE(sysdate)
            GROUP BY g.MTNM
           ) thisWeek

            LEFT OUTER JOIN
            (
                SELECT g.MTNM, DENSE_RANK() OVER (ORDER BY COUNT(g.MTNM) DESC) rank
                FROM groups g
                WHERE g.MTNM != '0'
                  AND g.CREATEDAT BETWEEN TO_DATE(sysdate-14)
                  AND   TO_DATE(sysdate-7)
                GROUP BY g.MTNM
                ) prevWeek

                ON prevWeek.MTNM = thisWeek.MTNM
            ORDER BY changeRank DESC
        ]]>
    </select>

    <insert id="followMountainFunction" parameterType="map">
        <if test='likeYN.equals("Y")'>
        <![CDATA[
            MERGE INTO MTLIKE
            USING DUAL
            ON (mtNum = #{mntilistno} AND userId = #{userId})
            WHEN MATCHED THEN
            UPDATE SET
                    likeYN = #{likeYN},
                    createdAT = sysdate
            WHEN NOT MATCHED THEN
                INSERT (mtNum, userId, likeYN, createdAT)
                VALUES (#{mntilistno},#{userId},#{likeYN},sysdate)
        ]]>
        </if>
        <if test='likeYN.equals("N")'>
            UPDATE mtLike
            SET mtNum = #{mntilistno},
                userId = #{userId},
                likeYn = #{likeYN},
                createdAt = sysdate
            WHERE mtNum = #{mntilistno}
              AND userId = #{userId}
        </if>
        <selectKey keyProperty="mtNum" resultType="_int" order="AFTER">
            SELECT mtNum
            FROM mtLike
            WHERE mtNum = #{mntilistno}
            AND userId = #{userId}
        </selectKey>
    </insert>
    <select id="checkMtLike" resultType="string" parameterType="map">
        <![CDATA[
            SELECT LIKEYN
            FROM MTLIKE
            WHERE mtNum = #{mntilistno}
              AND userId = #{userId}
        ]]>
    </select>
    <select id="followMountainCount" resultType="_int" parameterType="string">
        <![CDATA[
            SELECT COUNT(*)
            FROM MTLIKE
            WHERE LIKEYN = 'Y'
            AND MTNUM = #{mntilistno}
        ]]>
    </select>
</mapper>