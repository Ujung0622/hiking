<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mountain">
    <select id="selectMountainByRank" resultType="map" parameterType="int">
        <![CDATA[
            SELECT thisWeek.MTNM, NVL(prevWeek.rank - thisWeek.rank,'-999') changeRank
            FROM (
            SELECT g.MTNM,DENSE_RANK() OVER (ORDER BY COUNT(g.MTNM) DESC) rank
            FROM groups g
            WHERE g.MTNM != '0'
              AND g.CREATEDAT BETWEEN TO_DATE(sysdate-7)
              AND   TO_DATE(sysdate)
            GROUP BY g.MTNM
           ) thisWeek

            LEFT OUTER JOIN
            (
                SELECT g.MTNM, DENSE_RANK() OVER (ORDER BY COUNT(g.MTNM) DESC) rank
                FROM groups g
                WHERE g.MTNM != '0'
                  AND g.CREATEDAT BETWEEN TO_DATE(sysdate-14)
                  AND   TO_DATE(sysdate-7)
                GROUP BY g.MTNM
                ) prevWeek

                ON prevWeek.MTNM = thisWeek.MTNM
            ORDER BY changeRank DESC
        ]]>
    </select>
    <select id="selectTrailByRank" resultType="map">
        SELECT MNTN_NM, MNTN_CODE
        FROM trailInfo
        GROUP BY MNTN_NM, MNTN_CODE
    </select>

    <insert id="followMountainFunction" parameterType="map">
        <if test='likeYN.equals("Y")'>
        <![CDATA[
            MERGE INTO MTLIKE
            USING DUAL
            ON (mtNum = #{mntilistno} AND userId = #{userId})
            WHEN MATCHED THEN
            UPDATE SET
                    likeYN = #{likeYN},
                    createdAT = sysdate
            WHEN NOT MATCHED THEN
                INSERT (mtNum, userId, likeYN, createdAT)
                VALUES (#{mntilistno},#{userId},#{likeYN},sysdate)
        ]]>
        </if>
        <if test='likeYN.equals("N")'>
            UPDATE mtLike
            SET mtNum = #{mntilistno},
                userId = #{userId},
                likeYn = #{likeYN},
                createdAt = sysdate
            WHERE mtNum = #{mntilistno}
              AND userId = #{userId}
        </if>
        <selectKey keyProperty="mtNum" resultType="_int" order="AFTER">
            SELECT mtNum
            FROM mtLike
            WHERE mtNum = #{mntilistno}
            AND userId = #{userId}
        </selectKey>
    </insert>
    <select id="checkMtLike" resultType="string" parameterType="map">
        <![CDATA[
            SELECT LIKEYN
            FROM MTLIKE
            WHERE mtNum = #{mntilistno}
              AND userId = #{userId}
        ]]>
    </select>
    <select id="followMountainCount" resultType="_int" parameterType="string">
        <![CDATA[
            SELECT COUNT(*)
            FROM MTLIKE
            WHERE LIKEYN = 'Y'
            AND MTNUM = #{mntilistno}
        ]]>
    </select>
    <insert id="insertTrailInfo" parameterType="map">
        INSERT INTO TRAILINFO
        VALUES (
            #{FID},
            #{PMNTN_LT},
            #{PMNTN_GODN},
            #{MNTN_CODE},
            #{MNTN_ID},
            #{PMNTN_MAIN},
            #{PMNTN_UPPL},
            #{PMNTN_RISK},
            #{PMNTN_CLS_},
            #{PMNTN_NM},
            #{PMNTN_MTRQ},
            #{PMNTN_SN},
            #{DATA_STDR_},
            #{PMNTN_DFFL},
            #{PMNTN_RECO},
            #{MNTN_NM},
            #{PMNTN_CNRL}
        )
    </insert>

    <insert id="insertTrailLocation" parameterType="map">
        INSERT INTO TRAILLOCATION
        VALUES (
            #{MNTN_CODE},
            #{FID},
            (select NVL(MAX(locationOrder),0)+1
            FROM TrailLocation
            WHERE MNTN_CODE = #{MNTN_CODE}
            AND FID = #{FID}),
            #{LOCATIONX},
            #{LOCATIONY}
        )
    </insert>

    <insert id="insertTrailSpot" parameterType="map">
        INSERT INTO TRAILSPOT
        VALUES (
            #{FID},
            #{PMNTN_SPOT},
            #{MNTN_CODE},
            #{MANAGE_SP1},
            #{MANAGE_SP2},
            #{DETAIL_SPO},
            #{ETC_MATTER},
            #{MNTN_NM},
            #{PAST_SPOT_},
            #{MNTN_ID},
            #{LOCATIONX},
            #{LOCATIONY}
        )
    </insert>

    <select id="selectTrailLocation" resultType="map" parameterType="map">
        SELECT *
        FROM trailLocation
        WHERE MNTN_CODE = #{MNTN_CODE}
          AND FID = #{FID}
        ORDER BY fid ASC, locationorder ASC
    </select>

    <select id="selectTrailInfo" resultType="map" parameterType="map">
        SELECT DISTINCT ti.FID, ti.MNTN_CODE, ti.MNTN_NM,
            (
            SELECT DISTINCT FIRST_VALUE(tl.LOCATIONX) over (PARTITION BY tl.FID ORDER BY tl.LOCATIONORDER ASC)
             FROM TRAILLOCATION tl
             WHERE tl.MNTN_CODE = #{MNTN_CODE}
                    AND FID = #{FID}
            ) LOCATIONX,
            (
            SELECT DISTINCT FIRST_VALUE(tl.LOCATIONY) over (PARTITION BY tl.FID ORDER BY tl.LOCATIONORDER ASC)
             FROM TRAILLOCATION tl
             WHERE tl.MNTN_CODE = #{MNTN_CODE}
                AND FID = #{FID}
            ) LOCATIONY
        FROM TrailInfo ti
        WHERE ti.MNTN_CODE = #{MNTN_CODE}
        ORDER BY FID ASC
    </select>

    <select id="selectCourseByMNTN_CODE" resultType="map" parameterType="map">
        SELECT FID,NVL2(TRIM(PMNTN_NM),TO_CHAR(CONCAT(FID+1,' ')) || TO_CHAR(PMNTN_NM),FID+1||' 구간')
        FROM TRAILINFO ti2
        WHERE MNTN_CODE = #{MNTN_CODE}
    </select>

<!--    <select id="selectTrailInfo" resultType="map" parameterType="map">-->
<!--        SELECT ti.PMNTN_LT, ti.PMNTN_GODN, ti.MNTN_CODE, ti.PMNTN_MAIN, ti.PMNTN_UPPL, ti.PMNTN_RISK, ti.PMNTN_CLS_, ti.PMNTN_NM, ti.PMNTN_MTRQ, ti.DATA_STDR_, ti.PMNTN_DFFL, ti.MNTN_NM, ti.PMNTN_CNRL, tl.LOCATIONX, tl.LOCATIONY-->
<!--        FROM trailInfo ti-->
<!--        LEFT JOIN trailSpot ts ON ti.MNTN_CODE = ts.MNTN_CODE-->
<!--        LEFT JOIN trailLocation tl ON ti.MNTN_CODE = tl.MNTN_CODE-->
<!--        WHERE ti.MNTN_CODE = #{MNTN_CODE}-->
<!--    </select>-->


    <select id="selectTrailSpot" resultType="map" parameterType="map">
        SELECT *
        FROM trailSpot
        WHERE MNTN_CODE = #{MNTN_CODE}
    </select>

</mapper>