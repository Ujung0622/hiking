<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="search">
    <select id="searchKeyword" resultType="map" parameterType="map">
        SELECT
        g.groupNum, g.name,
        g.staffCurrent,
        g.staffmax,
        g.detail,
        DECODE(g.status, 0, '마감', '모집중')         status,
        TO_CHAR(g.startDay, 'yyyy"년"MM"월"dd"일"') startDay,
        gm.storedFileName,
        NVL(ui.CONTENT2, 'basic_profile.PNG')    content2,
        u.nickname,
        u.id,
        g.area,
        g.type
        FROM groups g
            INNER JOIN groupsMedia gm
            ON g.groupNum = gm.groupNum
            INNER JOIN userWaiting uw
            ON g.groupNum = uw.groupNum
            INNER JOIN users u
            ON uw.userId = u.id
            INNER JOIN userInfo ui
            ON u.userNum = ui.userNum
        WHERE uw.userType = 0
          AND gm.mediaNum = 0
          AND g.staffMax != 1
        <if test="type.equals('none')">
            AND g.type IN (1,2)
        </if>
        <if test="!type.equals('none')">
            <choose>
                <when test="type.equals('group')">
                    AND g.type=1
                </when>
                <when test="type.equals('moim')">
                    AND g.type=2
                </when>
            </choose>
        </if>
        <if test="!period.equals('none')">
            <choose>
                <when test="period.equals('hour')">
                    AND g.createdAt >= sysdate - 1/24
                </when>
                <when test="period.equals('day')">
                    AND g.createdAt >= sysdate - 1
                </when>
                <when test="period.equals('week')">
                    AND g.createdAt >= sysdate - 7
                </when>
                <when test="period.equals('month')">
                    AND g.createdAt >= sysdate - 31
                </when>
            </choose>
        </if>
        AND g.name LIKE '%'||#{keyword}||'%'
        <if test="!sort.equals('none')">
            <choose>
                <when test="sort.equals('new')">
                    ORDER BY g.createdAt DESC
                </when>
                <when test="sort.equals('old')">
                    ORDER BY g.createdAt ASC
                </when>
            </choose>
        </if>
    </select>
</mapper>