<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="after">
    <insert id="insertAfter" parameterType="map">
        <selectKey keyProperty="afterNum" resultType="_int" order="BEFORE">
            SELECT AFTER_SEQ.nextval
            FROM dual
        </selectKey>
        <![CDATA[
            INSERT INTO groupAfter
            VALUES (
                   #{userNum},
                   AFTER_SEQ.currval,
                   #{groupNum},
                   #{mtNm},
                   #{title},
                   #{content},
                   sysdate
                   )
        ]]>
    </insert>
    <select id="checkAfterExist" resultType="_int" parameterType="map">
        <![CDATA[
            SELECT userNum
            FROM groupAfter
            WHERE userNum = #{userNum}
              AND groupNum = #{groupNum}
        ]]>
    </select>
    <select id="selectAllAfterList" resultType="map">
        <![CDATA[
            SELECT ga.afterNum, ga.userNum, ga.mtNm, ga.title, ga.content, TO_CHAR(ga.createdAt,'yyyy-mm-dd') createdAt, ui.content2
            FROM groupAfter ga, users u, userInfo ui
            WHERE ga.userNum = u.userNum
              AND u.userNum = ui.userNum
            ORDER BY ga.afterNum DESC
        ]]>
    </select>
    <select id="selectMainAfterList" resultType="map">
        <![CDATA[
            SELECT ga.afterNum, ga.mtNm, ga.title, TO_CHAR(ga.createdAt,'yyyy-mm-dd') createdAt, ui.content2
            FROM groupAfter ga, userInfo ui
            WHERE ga.userNum = ui.userNum
        ]]>
    </select>
    <insert id="insertCommentAfter" useGeneratedKeys="true" keyProperty="commentNum" parameterType="map">
        <selectKey keyProperty="commentNum" resultType="_int" order="BEFORE">
            SELECT afterComment_seq.nextval
            FROM dual
        </selectKey>
        <![CDATA[
            INSERT INTO groupafterComment
            VALUES  (
                    #{commentNum},
                    #{parentNum},
                    #{depts},
                     (select NVL(MAX(commentOrder),0)+1
                     FROM groupAfterComment
                     WHERE parentNum = #{parentNum}
                     AND afterNum = #{afterNum}),
                    #{afterNum},
                    #{content},
                    #{userId},
                    0,
                    sysdate
                    )
        ]]>
    </insert>
    <select id="selectCommentOne" resultType="map" parameterType="int">
        <![CDATA[
        SELECT gac.commentNum, gac.parentNum, gac.depts, gac.commentOrder, gac.content, u.nickname, TO_CHAR(gac.createdAt,'YYYY-MM-DD') createdAt
        FROM groupAfterComment gac, users u
        WHERE gac.userId = u.id
          AND commentNum = #{commentNum}
        ]]>
    </select>
    <select id="selectCommentByAfterNum" resultType="map" parameterType="int">
        <![CDATA[
        SELECT gac.commentNum, gac.parentNum, gac.depts, gac.commentOrder, gac.content, u.nickname, gac.subCommentCount, TO_CHAR(gac.createdAt,'YYYY-MM-DD') createdAt, ui.content2
        FROM groupAfterComment gac, users u, userInfo ui
        WHERE gac.userId = u.id
          AND   u.userNum = ui.userNum
          AND   AFTERNUM = #{afterNum}
        START WITH PARENTNUM = 0
            CONNECT BY PRIOR COMMENTNUM = PARENTNUM
            ORDER SIBLINGS BY COMMENTORDER
        ]]>
    </select>
</mapper>